<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
    <title>URBAN | NO PRESSURE NO DIAMOND</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- MQTT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.0.0/mqtt.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');

        :root {
            --blue: #2f00ff;
            --blue-dim: rgba(47,0,255,0.15);
            --blue-border: rgba(47,0,255,0.25);
            --red: #ff3d3d;
            --green: #00ff88;
            --bg-deep: #070b14;
            --bg-card: rgba(12, 18, 32, 0.95);
            --text-muted: #5a7a9a;
            --text-dim: #8aa4bc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg-deep);
            color: white;
            min-height: 100vh;
            font-family: 'Rajdhani', sans-serif;
            overflow-x: hidden;
        }

        /* Scanline overlay */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,255,0.02) 2px,
                rgba(0,0,255,0.02) 4px
            );
            pointer-events: none;
            z-index: 9999;
        }

        /* ========== NAVBAR ========== */
        .navbar {
            background: rgba(7, 11, 20, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--blue-border);
            padding: 14px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            background: transparent;
            border: 1px solid var(--blue-border);
            color: var(--text-dim);
            padding: 7px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 13px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: var(--blue);
            border-color: var(--blue);
            color: white;
        }

        .car-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .car-icon {
            width: 38px;
            height: 38px;
            background: var(--blue);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            clip-path: polygon(8% 0%, 100% 0%, 92% 100%, 0% 100%);
        }

        .car-icon i { font-size: 18px; color: white; }

        .car-title h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            font-weight: 900;
            color: white;
            letter-spacing: 3px;
            line-height: 1;
        }

        .car-title span {
            font-size: 11px;
            color: var(--blue);
            letter-spacing: 2px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.4);
            padding: 7px 16px;
            border-radius: 4px;
            border: 1px solid var(--blue-border);
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--blue);
        }

        .dot.online {
            background: var(--green);
            box-shadow: 0 0 8px var(--green);
            animation: blink 1.5s infinite;
        }

        .dot.offline { background: var(--red); }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .last-update {
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ========== BANNER ========== */
        .banner {
            background: linear-gradient(90deg, transparent, rgba(47,0,255,0.06), transparent);
            border-bottom: 1px solid var(--blue-border);
            padding: 8px 0;
            text-align: center;
            position: relative;
        }

        .banner::before, .banner::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--blue));
        }
        .banner::before { left: 0; }
        .banner::after { right: 0; background: linear-gradient(90deg, var(--blue), transparent); }

        .banner h3 {
            font-family: 'Orbitron', sans-serif;
            color: var(--blue);
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 6px;
            text-transform: uppercase;
        }

        /* ========== DASHBOARD ========== */
        .dashboard {
            max-width: 1500px;
            margin: 0 auto;
            padding: 24px 28px;
        }

        .section-label {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 3px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--blue-border);
        }

        /* ========== MAP ========== */
        .map-wrapper { margin-bottom: 28px; }

        .map-container {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--blue-border);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid var(--blue-border);
            background: rgba(0,0,0,0.3);
        }

        .map-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 14px;
            letter-spacing: 1px;
        }

        .map-header-left i { color: var(--blue); }

        .driver-status {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-dim);
        }

        #map {
            height: 300px;
            width: 100%;
            z-index: 1;
        }

        .location-info {
            display: flex;
            gap: 0;
            border-top: 1px solid var(--blue-border);
            flex-wrap: wrap;
        }

        .loc-item {
            flex: 1;
            padding: 10px 16px;
            font-size: 12px;
            font-family: 'Share Tech Mono', monospace;
            color: var(--text-muted);
            border-right: 1px solid var(--blue-border);
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 200px;
        }

        .loc-item:last-child { border-right: none; }
        .loc-item i { color: var(--blue); font-size: 11px; }

        /* ========== GAUGE GRID ========== */
        .gauge-section { margin-bottom: 28px; }

        .gauge-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 16px;
        }

        .gauge-card {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--blue-border);
            padding: 18px 16px 14px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .gauge-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--blue), #4d33ff);
        }

        .gauge-card.afr-card::before { background: linear-gradient(90deg, var(--red), #ff8844); }
        .gauge-card.temp-card::before { background: linear-gradient(90deg, #ff6622, #ffaa00); }
        .gauge-card.altitude-card::before { background: linear-gradient(90deg, #44ccff, #88ddff); }

        .gauge-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 3px;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gauge-label i { color: var(--blue); font-size: 14px; }
        .gauge-card.afr-card .gauge-label i { color: var(--red); }
        .gauge-card.temp-card .gauge-label i { color: #ff7722; }
        .gauge-card.altitude-card .gauge-label i { color: #44ccff; }

        .gauge-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 42px;
            font-weight: 900;
            line-height: 1;
            color: white;
            margin-bottom: 4px;
        }

        .gauge-card.speed-card .gauge-value { color: var(--blue); }
        .gauge-card.rpm-card .gauge-value { color: #ffcc44; }
        .gauge-card.afr-card .gauge-value { color: var(--green); }
        .gauge-card.tps-card .gauge-value { color: #44ccff; }
        .gauge-card.temp-card .gauge-value { color: #ff9933; }
        .gauge-card.altitude-card .gauge-value { color: #44ccff; }

        .gauge-unit-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .gauge-unit {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        .gauge-badge {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 3px 8px;
            border-radius: 3px;
            background: rgba(0,232,122,0.15);
            color: var(--green);
            border: 1px solid rgba(0,232,122,0.3);
        }

        .gauge-badge.warn {
            background: rgba(255,170,0,0.15);
            color: #ffaa00;
            border-color: rgba(255,170,0,0.3);
        }

        .gauge-badge.danger {
            background: rgba(255,61,61,0.15);
            color: var(--red);
            border-color: rgba(255,61,61,0.3);
        }

        .gauge-bar-track {
            margin-top: 12px;
            height: 4px;
            background: rgba(255,255,255,0.07);
            border-radius: 2px;
            overflow: hidden;
        }

        .gauge-bar-fill {
            height: 100%;
            border-radius: 2px;
            background: linear-gradient(90deg, var(--blue), #4d33ff);
            transition: width 0.4s ease;
        }

        .gauge-card.afr-card .gauge-bar-fill { background: linear-gradient(90deg, var(--red), #ff8844); }
        .gauge-card.tps-card .gauge-bar-fill { background: linear-gradient(90deg, #0099ff, #44ccff); }
        .gauge-card.temp-card .gauge-bar-fill { background: linear-gradient(90deg, #ff6622, #ffaa00); }
        .gauge-card.altitude-card .gauge-bar-fill { background: linear-gradient(90deg, #44ccff, #88ddff); }

        .gauge-value.no-data {
            color: var(--text-muted) !important;
            font-size: 28px;
        }

        /* ========== CHARTS SECTION ========== */
        .charts-section { margin-bottom: 28px; }

        .metric-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .temp-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--blue-border);
            padding: 16px 20px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .chart-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--blue), transparent);
        }

        .chart-card.afr-chart::before { background: linear-gradient(90deg, var(--red), transparent); }
        .chart-card.tps-chart::before { background: linear-gradient(90deg, #0099ff, transparent); }
        .chart-card.temp-chart::before { background: linear-gradient(90deg, #ff6622, transparent); }
        .chart-card.altitude-chart::before { background: linear-gradient(90deg, #44ccff, transparent); }

        .chart-title {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title i { color: var(--blue); }
        .chart-card.afr-chart .chart-title i { color: var(--red); }
        .chart-card.tps-chart .chart-title i { color: #44ccff; }
        .chart-card.temp-chart .chart-title i { color: #ff9933; }
        .chart-card.altitude-chart .chart-title i { color: #44ccff; }

        .chart-timeframe {
            font-size: 10px;
            letter-spacing: 1px;
            color: var(--text-muted);
            background: rgba(255,255,255,0.04);
            padding: 2px 8px;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.06);
        }

        .chart-canvas-wrap {
            position: relative;
            height: 130px;
        }

        .big-chart-card {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--blue-border);
            padding: 16px 20px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .big-chart-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--blue), #4d33ff, transparent);
        }

        .big-chart-wrap {
            position: relative;
            height: 160px;
        }

        /* ========== NUMBER CARDS ========== */
        .number-card {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--blue-border);
            padding: 18px 16px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .number-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--blue), #4d33ff);
        }

        .number-main-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 56px;
            font-weight: 900;
            color: var(--blue);
            line-height: 1;
            position: relative;
            z-index: 1;
        }

        .number-label {
            font-size: 10px;
            letter-spacing: 3px;
            color: var(--text-muted);
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .number-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 4px 10px;
            border-radius: 3px;
            margin-top: 10px;
            background: rgba(0,232,122,0.12);
            color: var(--green);
            border: 1px solid rgba(0,232,122,0.25);
            position: relative;
            z-index: 1;
        }

        .temp-number-card {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid rgba(255,102,34,0.3);
            padding: 18px 16px;
            position: relative;
            overflow: hidden;
        }

        .temp-number-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6622, #ffaa00);
        }

        .temp-number-card .number-main-value { color: #ff9933; }

        .altitude-number-card {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid rgba(68,204,255,0.3);
            padding: 18px 16px;
        }

        .altitude-number-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #44ccff, #88ddff);
        }

        .altitude-number-card .number-main-value { color: #44ccff; }

        /* ========== SENSOR GRID ========== */
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }

        .sensor-card {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--blue-border);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(10px);
        }

        .sensor-icon {
            width: 45px;
            height: 45px;
            background: rgba(47,0,255,0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sensor-icon i { font-size: 20px; color: var(--blue); }

        .sensor-info { flex: 1; }

        .sensor-label {
            color: var(--text-muted);
            font-size: 11px;
            letter-spacing: 1px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .sensor-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .sensor-unit {
            font-size: 11px;
            color: var(--text-dim);
            margin-left: 4px;
        }

        .sensor-trend {
            font-size: 11px;
            color: var(--green);
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
        }

        /* ========== DATA TABLE ========== */
        .table-section { margin-top: 28px; }

        .data-table-wrap {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--blue-border);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid var(--blue-border);
            background: rgba(0,0,0,0.3);
        }

        .table-header h3 {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-header h3 i { color: var(--blue); }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--green);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--green);
            animation: blink 1s infinite;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px 16px;
            color: var(--text-muted);
            font-weight: 700;
            font-size: 11px;
            letter-spacing: 2px;
            border-bottom: 1px solid var(--blue-border);
            background: rgba(0,0,0,0.2);
        }

        td {
            padding: 12px 16px;
            color: var(--text-dim);
            border-bottom: 1px solid rgba(255,255,255,0.04);
            font-family: 'Share Tech Mono', monospace;
            font-size: 13px;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(47,0,255,0.03); }

        .value-highlight { color: var(--blue); font-weight: 700; }

        /* ========== FOOTER ========== */
        .footer {
            text-align: center;
            padding: 24px;
            border-top: 1px solid var(--blue-border);
            margin-top: 40px;
        }

        .footer-gem { font-size: 20px; color: var(--blue); margin-bottom: 8px; }

        .footer-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 6px;
            color: var(--blue);
        }

        .footer-sub {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            letter-spacing: 1px;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1200px) {
            .gauge-grid { grid-template-columns: repeat(3, 1fr); }
            .metric-row { grid-template-columns: 1fr 1fr; }
            .sensor-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 900px) {
            .gauge-grid { grid-template-columns: repeat(2, 1fr); }
            .metric-row { grid-template-columns: 1fr; }
            .temp-row { grid-template-columns: 1fr; }
            .sensor-grid { grid-template-columns: 1fr; }
            .dashboard { padding: 16px; }
        }

        @media (max-width: 600px) {
            .gauge-grid { grid-template-columns: repeat(2, 1fr); }
            .navbar { flex-direction: column; gap: 12px; align-items: flex-start; }
            .gauge-value { font-size: 32px; }
            .nav-right { width: 100%; justify-content: space-between; }
            .location-info .loc-item { border-right: none; border-bottom: 1px solid var(--blue-border); }
        }
    </style>
</head>
<body>
    <!-- NAVBAR -->
    <div class="navbar">
        <div class="nav-left">
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> BACK
            </a>
            <div class="car-info">
                <div class="car-icon">
                    <i class="fas fa-car"></i>
                </div>
                <div class="car-title">
                    <h2>URBAN</h2>
                    <span>Daily Driver</span>
                </div>
            </div>
        </div>
        <div class="nav-right">
            <div class="connection-status">
                <span class="dot offline" id="statusDot"></span>
                <span id="statusText">OFFLINE</span>
            </div>
            <span class="last-update" id="lastUpdate">--:--:--</span>
        </div>
    </div>

    <!-- BANNER -->
    <div class="banner">
        <h3><i class="fas fa-gem"></i> &nbsp; NO PRESSURE NO DIAMOND &nbsp; <i class="fas fa-gem"></i></h3>
    </div>

    <div class="dashboard">
        <!-- MAP SECTION -->
        <div class="map-wrapper">
            <div class="section-label"><i class="fas fa-satellite" style="color:var(--blue)"></i> LIVE GPS TRACKING</div>
            <div class="map-container">
                <div class="map-header">
                    <div class="map-header-left">
                        <i class="fas fa-map-marked-alt"></i>
                        Live Location â€” Urban Driver
                    </div>
                    <div class="driver-status" id="driverStatus">
                        <i class="fas fa-circle" style="color: var(--blue); font-size: 8px;"></i>
                        Menunggu sinyal GPS...
                    </div>
                </div>
                <div id="map"></div>
                <div class="location-info">
                    <span class="loc-item" id="locationAddress">
                        <i class="fas fa-map-pin"></i> Lat: --, Lng: --
                    </span>
                    <span class="loc-item" id="locationAccuracy">
                        <i class="fas fa-satellite-dish"></i> Akurasi: -- m
                    </span>
                    <span class="loc-item" id="driverSpeed">
                        <i class="fas fa-tachometer-alt"></i> Kecepatan: -- km/h
                    </span>
                    <span class="loc-item" id="lastLocationUpdate">
                        <i class="fas fa-clock"></i> Update: --
                    </span>
                </div>
            </div>
        </div>

        <!-- GAUGE CARDS -->
        <div class="gauge-section">
            <div class="section-label"><i class="fas fa-gauge-high" style="color:var(--blue)"></i> SENSOR READINGS</div>
            <div class="gauge-grid">
                <!-- SPEED -->
                <div class="gauge-card speed-card">
                    <div class="gauge-label">
                        <span>SPEED</span>
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="gauge-value no-data" id="speedValue">--</div>
                    <div class="gauge-unit-row">
                        <span class="gauge-unit">km/h</span>
                        <span class="gauge-badge" id="speedBadge">--</span>
                    </div>
                    <div class="gauge-bar-track">
                        <div class="gauge-bar-fill" id="speedBar" style="width:0%"></div>
                    </div>
                </div>

                <!-- RPM -->
                <div class="gauge-card rpm-card">
                    <div class="gauge-label">
                        <span>RPM</span>
                        <i class="fas fa-circle-notch"></i>
                    </div>
                    <div class="gauge-value no-data" id="rpmValue">--</div>
                    <div class="gauge-unit-row">
                        <span class="gauge-unit">RPM</span>
                        <span class="gauge-badge" id="rpmBadge">--</span>
                    </div>
                    <div class="gauge-bar-track">
                        <div class="gauge-bar-fill" id="rpmBar" style="width:0%"></div>
                    </div>
                </div>

                <!-- AFR -->
                <div class="gauge-card afr-card">
                    <div class="gauge-label">
                        <span>AIR-FUEL RATIO</span>
                        <i class="fas fa-gas-pump"></i>
                    </div>
                    <div class="gauge-value no-data" id="afrValue">--</div>
                    <div class="gauge-unit-row">
                        <span class="gauge-unit">Î»</span>
                        <span class="gauge-badge" id="afrBadge">--</span>
                    </div>
                    <div class="gauge-bar-track">
                        <div class="gauge-bar-fill" id="afrBar" style="width:0%"></div>
                    </div>
                </div>

                <!-- TPS -->
                <div class="gauge-card tps-card">
                    <div class="gauge-label">
                        <span>THROTTLE</span>
                        <i class="fas fa-sliders-h"></i>
                    </div>
                    <div class="gauge-value no-data" id="tpsValue">--</div>
                    <div class="gauge-unit-row">
                        <span class="gauge-unit">%</span>
                        <span class="gauge-badge" id="tpsBadge">--</span>
                    </div>
                    <div class="gauge-bar-track">
                        <div class="gauge-bar-fill" id="tpsBar" style="width:0%"></div>
                    </div>
                </div>

                <!-- TEMP -->
                <div class="gauge-card temp-card">
                    <div class="gauge-label">
                        <span>COOLANT TEMP</span>
                        <i class="fas fa-temperature-high"></i>
                    </div>
                    <div class="gauge-value no-data" id="tempValue">--</div>
                    <div class="gauge-unit-row">
                        <span class="gauge-unit">Â°C</span>
                        <span class="gauge-badge" id="tempBadge">--</span>
                    </div>
                    <div class="gauge-bar-track">
                        <div class="gauge-bar-fill" id="tempBar" style="width:0%"></div>
                    </div>
                </div>

                <!-- ALTITUDE -->
                <div class="gauge-card altitude-card">
                    <div class="gauge-label">
                        <span>ALTITUDE</span>
                        <i class="fas fa-mountain"></i>
                    </div>
                    <div class="gauge-value no-data" id="altitudeValue">--</div>
                    <div class="gauge-unit-row">
                        <span class="gauge-unit">meter</span>
                        <span class="gauge-badge" id="altitudeBadge">MSL</span>
                    </div>
                    <div class="gauge-bar-track">
                        <div class="gauge-bar-fill" id="altitudeBar" style="width:0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CHARTS SECTION -->
        <div class="charts-section">
            <div class="section-label"><i class="fas fa-chart-line" style="color:var(--blue)"></i> HISTORY CHARTS</div>

            <!-- Speed + RPM Combined Chart -->
            <div class="big-chart-card">
                <div class="chart-title">
                    <span><i class="fas fa-tachometer-alt"></i> &nbsp; SPEED & RPM â€” 30 DETIK TERAKHIR</span>
                    <span class="chart-timeframe">30s</span>
                </div>
                <div class="big-chart-wrap">
                    <canvas id="speedRpmChart"></canvas>
                </div>
            </div>

            <!-- Row: AFR Chart | TPS Chart | Live Metrics -->
            <div class="metric-row">
                <div class="chart-card afr-chart">
                    <div class="chart-title">
                        <span><i class="fas fa-gas-pump"></i> &nbsp; AFR / LAMBDA</span>
                        <span class="chart-timeframe">30s</span>
                    </div>
                    <div class="chart-canvas-wrap">
                        <canvas id="afrChart"></canvas>
                    </div>
                </div>

                <div class="chart-card tps-chart">
                    <div class="chart-title">
                        <span><i class="fas fa-sliders-h" style="color:#44ccff"></i> &nbsp; THROTTLE POSITION</span>
                        <span class="chart-timeframe">30s</span>
                    </div>
                    <div class="chart-canvas-wrap">
                        <canvas id="tpsChart"></canvas>
                    </div>
                </div>

                <!-- Live Metrics Card -->
                <div class="chart-card" style="display:flex; flex-direction:column; justify-content:center;">
                    <div class="chart-title">
                        <span><i class="fas fa-gauge-high"></i> &nbsp; LIVE METRICS</span>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div>
                            <div style="font-size:10px;letter-spacing:2px;color:var(--text-muted);">MAX SPEED</div>
                            <div style="font-family:'Orbitron'; font-size:26px; color:var(--blue);" id="maxSpeed">--</div>
                            <div style="font-size:11px;color:var(--text-muted)">km/h</div>
                        </div>
                        <div>
                            <div style="font-size:10px;letter-spacing:2px;color:var(--text-muted);">MAX RPM</div>
                            <div style="font-family:'Orbitron'; font-size:26px; color:#ffcc44;" id="maxRpm">--</div>
                            <div style="font-size:11px;color:var(--text-muted)">RPM</div>
                        </div>
                        <div>
                            <div style="font-size:10px;letter-spacing:2px;color:var(--text-muted);">RUN TIME</div>
                            <div style="font-family:'Share Tech Mono'; font-size:22px; color:white;" id="runTime">0:00</div>
                            <div style="font-size:11px;color:var(--text-muted)">menit</div>
                        </div>
                        <div>
                            <div style="font-size:10px;letter-spacing:2px;color:var(--text-muted);">ENGINE LOAD</div>
                            <div style="font-family:'Orbitron'; font-size:26px; color:#44ccff;" id="engineLoad">--</div>
                            <div style="font-size:11px;color:var(--text-muted)">%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TEMPERATURE SECTION -->
            <div class="section-label" style="margin-top:4px;"><i class="fas fa-temperature-high" style="color:#ff9933"></i> COOLANT TEMPERATURE</div>
            <div class="temp-row">
                <!-- Temperature Number Card -->
                <div class="temp-number-card" id="tempNumberCard">
                    <div class="number-label">
                        <i class="fas fa-temperature-high"></i> SUHU MESIN
                    </div>
                    <div>
                        <span class="number-main-value" id="tempBigValue">--</span>
                        <span class="temp-unit-big">Â°C</span>
                    </div>
                    <div class="number-status-badge" id="tempStatusBadge">
                        <i class="fas fa-circle" style="font-size:7px;"></i>
                        MENUNGGU DATA
                    </div>
                </div>

                <!-- Temperature Chart -->
                <div class="chart-card temp-chart">
                    <div class="chart-title">
                        <span><i class="fas fa-fire"></i> &nbsp; TEMPERATURE HISTORY â€” 30 DETIK TERAKHIR</span>
                        <span class="chart-timeframe">30s</span>
                    </div>
                    <div style="position:relative; height: 160px;">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ALTITUDE SECTION -->
            <div class="section-label" style="margin-top:20px;"><i class="fas fa-mountain" style="color:#44ccff"></i> ALTITUDE TRACKING</div>
            <div class="temp-row">
                <!-- Altitude Number Card -->
                <div class="altitude-number-card" id="altitudeNumberCard">
                    <div class="number-label" style="color:#44ccff;">
                        <i class="fas fa-mountain"></i> KETINGGIAN
                    </div>
                    <div>
                        <span class="number-main-value" id="altitudeBigValue" style="color:#44ccff;">--</span>
                        <span class="temp-unit-big">mdpl</span>
                    </div>
                    <div class="number-status-badge" id="altitudeStatusBadge" style="background:rgba(68,204,255,0.12); color:#44ccff; border-color:rgba(68,204,255,0.25);">
                        <i class="fas fa-circle" style="font-size:7px;"></i>
                        MENUNGGU DATA
                    </div>
                </div>

                <!-- Altitude Chart -->
                <div class="chart-card altitude-chart">
                    <div class="chart-title">
                        <span><i class="fas fa-chart-line" style="color:#44ccff"></i> &nbsp; ALTITUDE HISTORY â€” 30 DETIK TERAKHIR</span>
                        <span class="chart-timeframe">30s</span>
                    </div>
                    <div style="position:relative; height: 160px;">
                        <canvas id="altitudeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- SENSOR GRID -->
        <div class="sensor-grid">
            <div class="sensor-card">
                <div class="sensor-icon">
                    <i class="fas fa-stopwatch"></i>
                </div>
                <div class="sensor-info">
                    <div class="sensor-label">RUN TIME</div>
                    <div>
                        <span class="sensor-value" id="runTimeSmall">0:00</span>
                        <span class="sensor-unit">menit</span>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- DATA TABLE -->
        <div class="table-section">
            <div class="section-label"><i class="fas fa-microchip" style="color:var(--blue)"></i> SENSOR LOG</div>
            <div class="data-table-wrap">
                <div class="table-header">
                    <h3><i class="fas fa-table"></i> REAL-TIME DATA LOG</h3>
                    <div class="live-indicator">
                        <span class="live-dot"></span>
                        LIVE
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>TIMESTAMP</th>
                            <th>SPEED</th>
                            <th>RPM</th>
                            <th>AFR (Î»)</th>
                            <th>TPS</th>
                            <th>TEMP</th>
                            <th>ALTITUDE</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="sensorLog">
                        <tr>
                            <td>--:--:--</td>
                            <td>-- km/h</td>
                            <td>-- RPM</td>
                            <td>-- Î»</td>
                            <td>--%</td>
                            <td>--Â°C</td>
                            <td>-- m</td>
                            <td style="color:var(--text-muted);">STANDBY</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
        <div class="footer-gem"><i class="fas fa-gem"></i></div>
        <div class="footer-title">NO PRESSURE NO DIAMOND</div>
        <div class="footer-sub">Urban Division Â· Real-time GPS from Driver's Phone</div>
    </div>

    <script>
        // ========== MQTT CONFIGURATION ==========
        const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt';
        const MQTT_OPTIONS = {
            clientId: 'urban_dash_' + Math.random().toString(16).substring(2, 10),
            clean: true,
            reconnectPeriod: 3000
        };

        console.log('ðŸ”µ Connecting to MQTT broker...');
        const client = mqtt.connect(MQTT_BROKER, MQTT_OPTIONS);

        // ========== MAP INITIALIZATION ==========
        let map, marker, circle;
        let isMapInitialized = false;
        let lastLocation = null;

        const defaultLat = -6.2088;
        const defaultLng = 106.8456;

        function initMap(lat = defaultLat, lng = defaultLng) {
            if (isMapInitialized) return;

            map = L.map('map').setView([lat, lng], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            const carIcon = L.divIcon({
                html: '<i class="fas fa-car" style="font-size:28px;color:#2f00ff;text-shadow:0 0 12px rgba(47,0,255,0.8);"></i>',
                className: 'custom-car-icon',
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });

            marker = L.marker([lat, lng], { icon: carIcon }).addTo(map);
            circle = L.circle([lat, lng], {
                radius: 50,
                color: '#2f00ff',
                weight: 1,
                opacity: 0.3,
                fillColor: '#2f00ff',
                fillOpacity: 0.08
            }).addTo(map);

            isMapInitialized = true;
        }

        function updateLocation(lat, lng, accuracy = 25, speed = 0) {
            if (lastLocation && 
                lastLocation.lat === lat && 
                lastLocation.lng === lng) return;

            lastLocation = { lat, lng, accuracy, speed };
            
            if (!isMapInitialized) initMap(lat, lng);

            try {
                marker.setLatLng([lat, lng]);
                circle.setLatLng([lat, lng]);
                circle.setRadius(accuracy);
                map.setView([lat, lng], 16);

                document.getElementById('locationAddress').innerHTML =
                    `<i class="fas fa-map-pin"></i> Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                document.getElementById('locationAccuracy').innerHTML =
                    `<i class="fas fa-satellite-dish"></i> Akurasi: ${Math.round(accuracy)} m`;
                document.getElementById('driverSpeed').innerHTML =
                    `<i class="fas fa-tachometer-alt"></i> Kecepatan: ${Math.round(speed)} km/h`;

                const now = new Date();
                document.getElementById('lastLocationUpdate').innerHTML =
                    `<i class="fas fa-clock"></i> Update: ${now.toLocaleTimeString('id-ID')}`;

                document.getElementById('driverStatus').innerHTML = speed > 0 ?
                    `<i class="fas fa-circle" style="color:#00ff88;font-size:8px;"></i> Driver Online Â· ${Math.round(speed)} km/h` :
                    `<i class="fas fa-circle" style="color:#00ff88;font-size:8px;"></i> Driver Online`;
            } catch (e) {
                console.error('Map update error:', e);
            }
        }

        // ========== CHARTS INITIALIZATION ==========
        const maxDataPoints = 30;
        const timeLabels = Array.from({ length: maxDataPoints }, (_, i) => `-${maxDataPoints - i}s`);

        const speedData = new Array(maxDataPoints).fill(null);
        const rpmData = new Array(maxDataPoints).fill(null);
        const afrData = new Array(maxDataPoints).fill(null);
        const tpsData = new Array(maxDataPoints).fill(null);
        const tempHistData = new Array(maxDataPoints).fill(null);
        const altitudeData = new Array(maxDataPoints).fill(null);

        function shiftPush(arr, val) {
            arr.shift();
            arr.push(val);
        }

        const commonGridColor = 'rgba(255,255,255,0.04)';
        const commonTickColor = '#5a7a9a';

        // Speed + RPM Chart
        const speedRpmChart = new Chart(
            document.getElementById('speedRpmChart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'Speed (km/h)',
                            data: speedData,
                            borderColor: '#2f00ff',
                            backgroundColor: 'rgba(47,0,255,0.06)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'RPM (Ã—100)',
                            data: rpmData,
                            borderColor: '#ffaa00',
                            backgroundColor: 'rgba(255,170,0,0.04)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    animation: { duration: 300 },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { color: '#8aa4bc', font: { size: 11 } } },
                        tooltip: { backgroundColor: '#0c1220', titleColor: '#fff', bodyColor: '#8aa4bc' }
                    },
                    scales: {
                        x: { grid: { color: commonGridColor }, ticks: { color: commonTickColor, font: { size: 10 } } },
                        y: {
                            position: 'left',
                            grid: { color: 'rgba(47,0,255,0.07)' },
                            ticks: { color: '#2f00ff', font: { size: 10 } },
                            title: { display: true, text: 'km/h', color: '#2f00ff', font: { size: 10 } }
                        },
                        y1: {
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#ffaa00', font: { size: 10 } },
                            title: { display: true, text: 'RPM Ã—100', color: '#ffaa00', font: { size: 10 } }
                        }
                    }
                }
            }
        );

        // AFR Chart
        const afrChart = new Chart(
            document.getElementById('afrChart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'AFR (Î»)',
                            data: afrData,
                            borderColor: '#ff3d3d',
                            backgroundColor: 'rgba(255,61,61,0.07)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            fill: true
                        },
                        {
                            label: 'Stoich 14.7',
                            data: new Array(maxDataPoints).fill(14.7),
                            borderColor: 'rgba(255,255,255,0.15)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 300 },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: commonGridColor }, ticks: { color: commonTickColor, font: { size: 10 } } },
                        y: { grid: { color: 'rgba(255,61,61,0.07)' }, ticks: { color: '#ff3d3d', font: { size: 10 } }, min: 10, max: 20 }
                    }
                }
            }
        );

        // TPS Chart
        const tpsChart = new Chart(
            document.getElementById('tpsChart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'TPS (%)',
                        data: tpsData,
                        borderColor: '#44ccff',
                        backgroundColor: 'rgba(68,204,255,0.06)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 300 },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: commonGridColor }, ticks: { color: commonTickColor, font: { size: 10 } } },
                        y: { grid: { color: 'rgba(68,204,255,0.07)' }, ticks: { color: '#44ccff', font: { size: 10 } }, min: 0, max: 100 }
                    }
                }
            }
        );

        // Temperature Chart
        const tempChart = new Chart(
            document.getElementById('tempChart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Suhu (Â°C)',
                        data: tempHistData,
                        borderColor: '#ff9933',
                        backgroundColor: 'rgba(255,153,51,0.07)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 300 },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: commonGridColor }, ticks: { color: commonTickColor, font: { size: 10 } } },
                        y: { grid: { color: 'rgba(255,153,51,0.07)' }, ticks: { color: '#ff9933', font: { size: 10 } }, min: 0 }
                    }
                }
            }
        );

        // Altitude Chart
        const altitudeChart = new Chart(
            document.getElementById('altitudeChart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Altitude (m)',
                        data: altitudeData,
                        borderColor: '#44ccff',
                        backgroundColor: 'rgba(68,204,255,0.06)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 300 },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: commonGridColor }, ticks: { color: commonTickColor, font: { size: 10 } } },
                        y: { 
                            grid: { color: 'rgba(68,204,255,0.07)' }, 
                            ticks: { color: '#44ccff', font: { size: 10 } },
                            title: { display: true, text: 'meter', color: '#44ccff', font: { size: 10 } }
                        }
                    }
                }
            }
        );

        // ========== MAX TRACKERS ==========
        let maxSpeed = 0;
        let maxRpm = 0;
        let maxAltitude = 0;

        // ========== GAUGE UPDATE FUNCTIONS ==========
        function setGaugeReady(el) {
            el.classList.remove('no-data');
        }

        function updateSpeed(val) {
            const v = parseInt(val) || 0;
            setGaugeReady(document.getElementById('speedValue'));
            document.getElementById('speedValue').textContent = v;
            document.getElementById('speedBar').style.width = Math.min(100, v / 2) + '%';

            if (v > maxSpeed) {
                maxSpeed = v;
                document.getElementById('maxSpeed').textContent = v;
            }

            const badge = document.getElementById('speedBadge');
            if (v === 0) { badge.textContent = 'IDLE'; badge.className = 'gauge-badge'; }
            else if (v < 80) { badge.textContent = 'NORMAL'; badge.className = 'gauge-badge'; }
            else if (v < 140) { badge.textContent = 'FAST'; badge.className = 'gauge-badge warn'; }
            else { badge.textContent = 'LIMIT'; badge.className = 'gauge-badge danger'; }

            shiftPush(speedData, v);
            speedRpmChart.update('none');
        }

        function updateRpm(val) {
            const v = parseInt(val) || 0;
            setGaugeReady(document.getElementById('rpmValue'));
            document.getElementById('rpmValue').textContent = v;
            document.getElementById('rpmBar').style.width = Math.min(100, v / 120) + '%';

            if (v > maxRpm) {
                maxRpm = v;
                document.getElementById('maxRpm').textContent = v;
            }

            const badge = document.getElementById('rpmBadge');
            if (v < 3000) { badge.textContent = 'LOW'; badge.className = 'gauge-badge'; }
            else if (v < 7000) { badge.textContent = 'MID'; badge.className = 'gauge-badge warn'; }
            else { badge.textContent = 'HIGH'; badge.className = 'gauge-badge danger'; }

            shiftPush(rpmData, v / 100);
            speedRpmChart.update('none');
        }

        function updateAfr(val) {
            const v = parseFloat(val);
            if (isNaN(v)) return;
            const vStr = v.toFixed(1);

            setGaugeReady(document.getElementById('afrValue'));
            document.getElementById('afrValue').textContent = vStr;
            document.getElementById('afrBar').style.width = Math.min(100, ((v - 10) / 10) * 100) + '%';

            const el = document.getElementById('afrValue');
            const badge = document.getElementById('afrBadge');

            if (v < 12) {
                el.style.color = '#ff4444';
                badge.textContent = 'RICH';
                badge.className = 'gauge-badge danger';
            } else if (v > 16) {
                el.style.color = '#ffaa00';
                badge.textContent = 'LEAN';
                badge.className = 'gauge-badge warn';
            } else {
                el.style.color = '#00ff88';
                badge.textContent = 'STOICH';
                badge.className = 'gauge-badge';
            }

            shiftPush(afrData, v);
            afrChart.update('none');
        }

        function updateTps(val) {
            const v = parseInt(val) || 0;
            setGaugeReady(document.getElementById('tpsValue'));
            document.getElementById('tpsValue').textContent = v;
            document.getElementById('tpsBar').style.width = v + '%';

            const load = Math.min(100, Math.round(v * 0.8 + 20));
            document.getElementById('engineLoad').textContent = load;

            const badge = document.getElementById('tpsBadge');
            if (v < 30) { badge.textContent = 'LIGHT'; badge.className = 'gauge-badge'; }
            else if (v < 70) { badge.textContent = 'MED'; badge.className = 'gauge-badge warn'; }
            else { badge.textContent = 'FULL'; badge.className = 'gauge-badge danger'; }

            shiftPush(tpsData, v);
            tpsChart.update('none');
        }

        function updateTemp(val) {
            const v = parseInt(val) || 0;

            setGaugeReady(document.getElementById('tempValue'));
            document.getElementById('tempValue').textContent = v;
            document.getElementById('tempBar').style.width = Math.min(100, (v / 120) * 100) + '%';

            document.getElementById('tempBigValue').textContent = v;

            const badge = document.getElementById('tempBadge');
            const statusBadge = document.getElementById('tempStatusBadge');

            if (v < 70) {
                badge.textContent = 'COLD';
                badge.className = 'gauge-badge';
                statusBadge.style.background = 'rgba(68,204,255,0.12)';
                statusBadge.style.color = '#44ccff';
                statusBadge.innerHTML = '<i class="fas fa-circle" style="font-size:7px;"></i> COLD â€” WARMING UP';
            } else if (v < 95) {
                badge.textContent = 'NORMAL';
                badge.className = 'gauge-badge';
                statusBadge.style.background = 'rgba(0,232,122,0.12)';
                statusBadge.style.color = '#00ff88';
                statusBadge.innerHTML = '<i class="fas fa-circle" style="font-size:7px;"></i> NORMAL OPERATING TEMP';
            } else if (v < 110) {
                badge.textContent = 'WARM';
                badge.className = 'gauge-badge warn';
                statusBadge.style.background = 'rgba(255,170,0,0.12)';
                statusBadge.style.color = '#ffaa00';
                statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle" style="font-size:7px;"></i> WARM â€” MONITOR';
            } else {
                badge.textContent = 'HOT!';
                badge.className = 'gauge-badge danger';
                statusBadge.style.background = 'rgba(255,61,61,0.15)';
                statusBadge.style.color = '#ff3d3d';
                statusBadge.innerHTML = '<i class="fas fa-fire" style="font-size:7px;"></i> OVERHEAT WARNING!';
            }

            shiftPush(tempHistData, v);
            tempChart.update('none');
        }

        function updateAltitude(val) {
            const v = parseInt(val) || 0;
            
            setGaugeReady(document.getElementById('altitudeValue'));
            document.getElementById('altitudeValue').textContent = v;
            
            const barWidth = Math.min(100, (v / 3000) * 100);
            document.getElementById('altitudeBar').style.width = barWidth + '%';
            
            document.getElementById('altitudeBigValue').textContent = v;
            
            if (v > maxAltitude) {
                maxAltitude = v;
            }
            
            const badge = document.getElementById('altitudeBadge');
            const statusBadge = document.getElementById('altitudeStatusBadge');
            
            if (v < 500) {
                badge.textContent = 'RENDAH';
                badge.className = 'gauge-badge';
                statusBadge.innerHTML = '<i class="fas fa-circle" style="font-size:7px;"></i> DATARAN RENDAH';
            } else if (v < 1000) {
                badge.textContent = 'SEDANG';
                badge.className = 'gauge-badge warn';
                statusBadge.innerHTML = '<i class="fas fa-circle" style="font-size:7px;"></i> DATARAN TINGGI';
            } else if (v < 2000) {
                badge.textContent = 'TINGGI';
                badge.className = 'gauge-badge warn';
                statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle" style="font-size:7px;"></i> PEGUNUNGAN';
            } else {
                badge.textContent = 'EKSTRIM';
                badge.className = 'gauge-badge danger';
                statusBadge.innerHTML = '<i class="fas fa-skull" style="font-size:7px;"></i> VERY HIGH ALTITUDE';
            }
            
            shiftPush(altitudeData, v);
            altitudeChart.update('none');
        }

        // ========== SENSOR LOG UPDATE ==========
        function updateSensorLog(data) {
            const tbody = document.getElementById('sensorLog');
            const timeStr = new Date().toLocaleTimeString('id-ID');

            const speed = data.kecepatan ?? '--';
            const rpm = data.rpm_coil ?? '--';
            const afr = data.afr_etanol != null ? data.afr_etanol.toFixed(1) : '--';
            const tps = data.throttle ?? '--';
            const temp = data.suhu ?? '--';
            const alt = data.altitude ?? data.ketinggian ?? '--';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span style="color:var(--blue);font-family:'Share Tech Mono'">${timeStr}</span></td>
                <td><span class="value-highlight">${speed}</span> km/h</td>
                <td>${rpm} RPM</td>
                <td>${afr} Î»</td>
                <td>${tps}%</td>
                <td>${temp}Â°C</td>
                <td>${alt} m</td>
                <td style="color:#00ff88;">ACTIVE</td>
            `;

            tbody.insertBefore(tr, tbody.firstChild);
            while (tbody.rows.length > 8) {
                tbody.deleteRow(tbody.rows.length - 1);
            }
        }

        // ========== MQTT HANDLERS ==========
        client.on('connect', () => {
            console.log('âœ… Connected to MQTT');
            document.getElementById('statusDot').className = 'dot online';
            document.getElementById('statusText').textContent = 'ONLINE';
            document.getElementById('statusText').style.color = '#00ff88';

            client.subscribe('location/urban/coordinates');
            client.subscribe('semeru/urban/#');
            console.log('ðŸ“¡ Subscribed to topics');
        });

        client.on('disconnect', () => {
            document.getElementById('statusDot').className = 'dot offline';
            document.getElementById('statusText').textContent = 'OFFLINE';
        });

        client.on('error', err => console.error('MQTT Error:', err));

        client.on('message', (topic, message) => {
            const value = message.toString();
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('id-ID');

            // GPS Location
            if (topic === 'location/urban/coordinates') {
                try {
                    const loc = JSON.parse(value);
                    if (loc.lat && loc.lng) {
                        updateLocation(
                            parseFloat(loc.lat),
                            parseFloat(loc.lng),
                            loc.accuracy || 25,
                            loc.speed || 0
                        );
                    }
                } catch {
                    const parts = value.split(',');
                    if (parts.length >= 2) {
                        const lat = parseFloat(parts[0]);
                        const lng = parseFloat(parts[1]);
                        if (!isNaN(lat) && !isNaN(lng)) {
                            updateLocation(lat, lng, parts[2] ? parseFloat(parts[2]) : 25, parts[3] ? parseFloat(parts[3]) : 0);
                        }
                    }
                }
                return;
            }

            // Sensor data
            if (topic === 'semeru/urban/speed') updateSpeed(value);
            if (topic === 'semeru/urban/rpm') updateRpm(value);
            if (topic === 'semeru/urban/afr') updateAfr(value);
            if (topic === 'semeru/urban/tps') updateTps(value);
            if (topic === 'semeru/urban/temp') updateTemp(value);
            if (topic === 'semeru/urban/altitude') updateAltitude(value);

            if (topic === 'semeru/urban/data') {
                try {
                    const data = JSON.parse(value);
                    if (data.waktu) {
                        const timeStr = `${data.waktu.menit}:${data.waktu.detik.toString().padStart(2, '0')}`;
                        document.getElementById('runTime').textContent = timeStr;
                        document.getElementById('runTimeSmall').textContent = timeStr;
                    }
                    if (data.kecepatan != null) updateSpeed(data.kecepatan);
                    if (data.rpm_coil != null) updateRpm(data.rpm_coil);
                    if (data.afr_etanol != null) updateAfr(data.afr_etanol);
                    if (data.throttle != null) updateTps(data.throttle);
                    if (data.suhu != null) updateTemp(data.suhu);
                    if (data.altitude != null) updateAltitude(data.altitude);
                    
                    updateSensorLog(data);
                } catch {}
            }
        });

        // ========== INITIALIZE ==========
        initMap();
    </script>
</body>
</html>
