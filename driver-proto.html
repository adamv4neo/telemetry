<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROTO DRIVER | Share Location + Altitude</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- MQTT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.0.0/mqtt.min.js"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a0f1f, #1e0a2b);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            background: rgba(255,170,0,0.1);
            border-bottom: 3px solid #ffaa00;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header i {
            font-size: 36px;
            color: #ffaa00;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .header p {
            color: #a0b8cc;
            font-size: 14px;
        }
        
        .card {
            background: rgba(26, 16, 46, 0.9);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,170,0,0.3);
        }
        
        .status-card {
            background: rgba(255,170,0,0.15);
            border-left: 6px solid #ffaa00;
        }
        
        .btn {
            background: linear-gradient(45deg, #ffaa00, #ff8800);
            border: none;
            color: white;
            padding: 18px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            margin: 15px 0;
            cursor: pointer;
            transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(255,170,0,0.5);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn.off {
            background: linear-gradient(45deg, #ff4d4d, #cc0000);
        }
        
        #map {
            height: 300px;
            width: 100%;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px solid #ffaa00;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255,170,0,0.2);
        }
        
        .info-label {
            color: #a0b8cc;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 20px;
            font-weight: bold;
            color: #ffaa00;
        }
        
        /* Khusus untuk altitude card */
        .info-item.altitude-item {
            grid-column: span 2;
            background: linear-gradient(145deg, rgba(68,204,255,0.1), rgba(68,204,255,0.05));
            border-left: 4px solid #44ccff;
        }
        
        .info-item.altitude-item .info-value {
            color: #44ccff;
            font-size: 28px;
        }
        
        .info-item.altitude-item i {
            color: #44ccff;
            margin-right: 8px;
        }
        
        .connection-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            background: rgba(255,170,0,0.15);
            color: #ffaa00;
        }
        
        .connection-badge.connected {
            background: rgba(0,255,136,0.15);
            color: #00ff88;
        }
        
        .gps-warning {
            background: rgba(255,170,0,0.2);
            border-left: 6px solid #ffaa00;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }
        
        .gps-warning i {
            color: #ffaa00;
            margin-right: 10px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #a0b8cc;
            font-size: 12px;
        }
        
        /* Elevation badge */
        .elevation-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
            background: rgba(68,204,255,0.2);
            color: #44ccff;
            border: 1px solid rgba(68,204,255,0.3);
        }
        
        @media (max-width: 480px) {
            .header h1 { font-size: 20px; }
            .btn { padding: 15px; font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <i class="fas fa-flag-checkered"></i>
        <div>
            <h1>PROTO DRIVER</h1>
            <p><i class="fas fa-trophy"></i> Racing Division ‚Ä¢ Share Live Location + Altitude</p>
        </div>
    </div>
    
    <div class="card status-card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <i class="fas fa-satellite-dish" style="color: #ffaa00; margin-right: 10px;"></i>
                <span>MQTT Status</span>
            </div>
            <span id="mqttStatus" class="connection-badge">üì° Connecting...</span>
        </div>
    </div>
    
    <div class="gps-warning" id="gpsWarning">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="warningMessage">Mengakses GPS, tunggu sinyal...</span>
    </div>
    
    <div class="card">
        <h3 style="margin-bottom: 15px; display: flex; gap: 10px;">
            <i class="fas fa-map-marked-alt" style="color: #ffaa00;"></i>
            Posisi & Ketinggian
        </h3>
        
        <div id="map"></div>
        
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label"><i class="fas fa-map-pin"></i> Latitude</div>
                <div class="info-value" id="latValue">-6.5405</div>
            </div>
            <div class="info-item">
                <div class="info-label"><i class="fas fa-map-pin"></i> Longitude</div>
                <div class="info-value" id="lngValue">106.8569</div>
            </div>
            <div class="info-item">
                <div class="info-label"><i class="fas fa-crosshairs"></i> Akurasi</div>
                <div class="info-value" id="accValue">5 m</div>
            </div>
            <div class="info-item">
                <div class="info-label"><i class="fas fa-tachometer-alt"></i> Kecepatan</div>
                <div class="info-value" id="speedValue">0 km/h</div>
            </div>
            
            <!-- ALTITUDE CARD - Menggunakan Open-Elevation API -->
            <div class="info-item altitude-item">
                <div class="info-label">
                    <i class="fas fa-mountain"></i> 
                    Ketinggian (Open-Elevation)
                    <span class="elevation-badge" id="altitudeSource">API</span>
                </div>
                <div class="info-value" id="altitudeValue">
                    <i class="fas fa-arrow-up"></i> -- m
                </div>
                <div style="font-size: 11px; color: #44ccff; margin-top: 5px;" id="altitudeStatus">
                    Menunggu koordinat...
                </div>
            </div>
        </div>
    </div>
    
    <button class="btn" id="shareBtn">
        <i class="fas fa-play"></i> 
        <span id="btnText">MULAI SHARE LOKASI</span>
    </button>
    
    <div class="card" id="statusCard" style="display: none;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="background: rgba(0,255,136,0.2); padding: 12px; border-radius: 50%;">
                <i class="fas fa-check-circle" style="color: #00ff88; font-size: 24px;"></i>
            </div>
            <div>
                <h3 style="color: #00ff88;">LOKASI TERKIRIM!</h3>
                <p style="color: #a0b8cc;">Dashboard akan menerima update lokasi + ketinggian</p>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <i class="fas fa-gem" style="color: #ffaa00;"></i>
        <p style="margin-top: 10px;">NO PRESSURE NO DIAMOND ‚Ä¢ PROTO DIVISION</p>
        <p style="margin-top: 5px;">Altitude via Open-Elevation API ‚Ä¢ Update Real-time</p>
    </div>

    <script>
        // ========== KONFIGURASI MQTT ==========
        const BROKER = 'wss://broker.emqx.io:8084/mqtt';
        const TOPIC = 'location/proto/coordinates';
        
        const client = mqtt.connect(BROKER, {
            clientId: 'proto_driver_' + Math.random().toString(16).substring(2, 8),
            clean: true,
            reconnectPeriod: 3000
        });
        
        // ========== VARIABEL GLOBAL ==========
        let map, marker, circle;
        let isSharing = false;
        let watchId = null;
        let intervalId = null;
        let lastLocation = null;
        
        // Cache untuk altitude (biar tidak request berulang untuk koordinat sama)
        let lastAltitudeRequest = null;
        let lastAltitudeValue = null;
        
        // ========== INISIALISASI MAP ==========
        function initMap(lat = -6.5405, lng = 106.8569) {
            if (!map) {
                map = L.map('map').setView([lat, lng], 16);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);
                
                const carIcon = L.divIcon({
                    html: '<i class="fas fa-flag-checkered" style="font-size: 32px; color: #ffaa00; text-shadow: 0 0 20px rgba(255,170,0,0.8);"></i>',
                    className: 'car-icon',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });
                
                marker = L.marker([lat, lng], { icon: carIcon }).addTo(map);
                
                circle = L.circle([lat, lng], {
                    radius: 20,
                    color: '#ffaa00',
                    weight: 2,
                    opacity: 0.4,
                    fillColor: '#ffaa00',
                    fillOpacity: 0.1
                }).addTo(map);
                
                console.log('üó∫Ô∏è Proto map initialized');
            }
        }
        
        // ========== FUNGSI AMBIL ALTITUDE DARI OPEN-ELEVATION API ==========
        async function fetchAltitude(lat, lng) {
            // Cek cache (hindari request berulang untuk koordinat yang sama)
            const coordKey = `${lat.toFixed(6)},${lng.toFixed(6)}`;
            if (lastAltitudeRequest === coordKey && lastAltitudeValue !== null) {
                return lastAltitudeValue;
            }
            
            try {
                const url = `https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`;
                console.log('üåÑ Requesting altitude for:', coordKey);
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const elevation = Math.round(data.results[0].elevation);
                    
                    // Update cache
                    lastAltitudeRequest = coordKey;
                    lastAltitudeValue = elevation;
                    
                    console.log(`üèîÔ∏è Altitude: ${elevation} m for ${coordKey}`);
                    
                    // Update UI
                    const altValue = document.getElementById('altitudeValue');
                    const altStatus = document.getElementById('altitudeStatus');
                    
                    if (altValue) {
                        altValue.innerHTML = `<i class="fas fa-arrow-up"></i> ${elevation} m`;
                    }
                    
                    if (altStatus) {
                        // Klasifikasi ketinggian
                        if (elevation < 100) {
                            altStatus.innerHTML = 'üìç Dataran rendah';
                            altStatus.style.color = '#88dd88';
                        } else if (elevation < 500) {
                            altStatus.innerHTML = '‚õ∞Ô∏è Perbukitan';
                            altStatus.style.color = '#ffaa00';
                        } else if (elevation < 1000) {
                            altStatus.innerHTML = 'üèîÔ∏è Pegunungan';
                            altStatus.style.color = '#ff8800';
                        } else {
                            altStatus.innerHTML = 'üóª Dataran tinggi (>1000m)';
                            altStatus.style.color = '#ff5555';
                        }
                    }
                    
                    return elevation;
                } else {
                    console.warn('No altitude data for', lat, lng);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Elevation API error:', error);
                
                // Update UI dengan error
                const altStatus = document.getElementById('altitudeStatus');
                if (altStatus) {
                    altStatus.innerHTML = '‚ö†Ô∏è Gagal ambil data ketinggian';
                    altStatus.style.color = '#ffaa00';
                }
                
                return null;
            }
        }
        
        // ========== UPDATE POSISI ==========
        async function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const speed = position.coords.speed || 0;
            
            console.log('üìç Proto GPS Fix:', { lat, lng, accuracy, speed });
            
            if (!map) initMap(lat, lng);
            
            marker.setLatLng([lat, lng]);
            circle.setLatLng([lat, lng]);
            circle.setRadius(accuracy);
            map.setView([lat, lng], 18);
            
            // Update UI dengan safe check
            const latEl = document.getElementById('latValue');
            const lngEl = document.getElementById('lngValue');
            const accEl = document.getElementById('accValue');
            const speedEl = document.getElementById('speedValue');
            
            if (latEl) latEl.innerHTML = lat.toFixed(6);
            if (lngEl) lngEl.innerHTML = lng.toFixed(6);
            if (accEl) accEl.innerHTML = Math.round(accuracy) + ' m';
            if (speedEl) speedEl.innerHTML = Math.round(speed * 3.6) + ' km/h';
            
            // üî• AMBIL ALTITUDE DARI API
            const altitude = await fetchAltitude(lat, lng);
            
            if (isSharing) {
                const gpsData = {
                    lat: lat,
                    lng: lng,
                    accuracy: Math.round(accuracy),
                    speed: Math.round(speed * 3.6),
                    altitude: altitude || 0,  // Sertakan altitude dalam data MQTT
                    timestamp: Date.now()
                };
                
                client.publish(TOPIC, JSON.stringify(gpsData));
                console.log('üì§ Proto GPS + Altitude sent:', gpsData);
                
                const warningEl = document.getElementById('gpsWarning');
                if (warningEl) warningEl.style.display = 'none';
            }
        }
        
        // ========== HANDLE ERROR GPS ==========
        function handleError(error) {
            console.error('‚ùå Proto GPS Error:', error);
            
            const warningEl = document.getElementById('gpsWarning');
            const messageEl = document.getElementById('warningMessage');
            
            if (!warningEl || !messageEl) return;
            
            let message = '';
            if (error.code === 1) {
                message = '‚ö†Ô∏è IZIN DITOLAK! Buka pengaturan browser ‚Üí izinkan lokasi';
            } else if (error.code === 2) {
                message = '‚ö†Ô∏è Sinyal GPS tidak tersedia. Keluar ruangan!';
            } else if (error.code === 3) {
                message = '‚ö†Ô∏è Timeout. Pastikan GPS AKTIF dan Anda di luar ruangan';
            }
            
            messageEl.innerHTML = message;
            warningEl.style.display = 'block';
        }
        
        // ========== MULAI SHARE ==========
        function startSharing() {
            if (!navigator.geolocation) {
                alert('Browser tidak mendukung GPS');
                return;
            }
            
            isSharing = true;
            
            const shareBtn = document.getElementById('shareBtn');
            const btnText = document.getElementById('btnText');
            const statusCard = document.getElementById('statusCard');
            const warningEl = document.getElementById('gpsWarning');
            const messageEl = document.getElementById('warningMessage');
            
            if (shareBtn) {
                shareBtn.classList.add('off');
                shareBtn.innerHTML = '<i class="fas fa-stop"></i> STOP SHARE LOKASI';
            }
            if (btnText) btnText.innerHTML = 'STOP SHARE LOKASI';
            if (statusCard) statusCard.style.display = 'block';
            if (warningEl) warningEl.style.display = 'block';
            if (messageEl) messageEl.innerHTML = 'Mencari sinyal GPS. Pastikan Anda di luar ruangan...';
            
            // Reset altitude status
            const altStatus = document.getElementById('altitudeStatus');
            if (altStatus) {
                altStatus.innerHTML = 'Mendapatkan data ketinggian...';
                altStatus.style.color = '#44ccff';
            }
            
            // Cek izin
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' }).then((result) => {
                    if (result.state === 'denied') {
                        alert('‚ö†Ô∏è IZIN LOKASI DITOLAK!\n\nBuka Pengaturan HP ‚Üí Aplikasi ‚Üí Browser ‚Üí Izin ‚Üí Lokasi ‚Üí IZINKAN');
                        stopSharing();
                        return;
                    }
                });
            }
            
            // Ambil lokasi dulu sebelum watch
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    await updatePosition(position);
                    
                    // Baru mulai watch
                    watchId = navigator.geolocation.watchPosition(updatePosition, handleError, {
                        enableHighAccuracy: true,
                        maximumAge: 10000,
                        timeout: 30000
                    });
                    
                    intervalId = setInterval(() => {
                        if (isSharing) {
                            navigator.geolocation.getCurrentPosition(updatePosition, null, {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 5000
                            });
                        }
                    }, 2000);
                },
                function(error) {
                    handleError(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 30000,
                    maximumAge: 0
                }
            );
        }
        
        // ========== STOP SHARE ==========
        function stopSharing() {
            isSharing = false;
            
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            if (intervalId !== null) {
                clearInterval(intervalId);
                intervalId = null;
            }
            
            const shareBtn = document.getElementById('shareBtn');
            const btnText = document.getElementById('btnText');
            const statusCard = document.getElementById('statusCard');
            const warningEl = document.getElementById('gpsWarning');
            
            if (shareBtn) {
                shareBtn.classList.remove('off');
                shareBtn.innerHTML = '<i class="fas fa-play"></i> MULAI SHARE LOKASI';
            }
            if (btnText) btnText.innerHTML = 'MULAI SHARE LOKASI';
            if (statusCard) statusCard.style.display = 'none';
            if (warningEl) warningEl.style.display = 'none';
        }
        
        // ========== MQTT HANDLER ==========
        client.on('connect', () => {
            console.log('‚úÖ‚úÖ‚úÖ Proto driver CONNECTED to MQTT!');
            const statusEl = document.getElementById('mqttStatus');
            if (statusEl) {
                statusEl.innerHTML = '‚úÖ Connected';
                statusEl.classList.add('connected');
            }
        });
        
        client.on('disconnect', () => {
            console.log('‚ùå Proto driver disconnected');
            const statusEl = document.getElementById('mqttStatus');
            if (statusEl) {
                statusEl.innerHTML = 'üì° Disconnected';
                statusEl.classList.remove('connected');
            }
        });
        
        // ========== EVENT LISTENER ==========
        const shareBtn = document.getElementById('shareBtn');
        if (shareBtn) {
            shareBtn.addEventListener('click', function() {
                if (isSharing) {
                    stopSharing();
                } else {
                    startSharing();
                }
            });
        }
        
        // ========== INITIALIZATION ==========
        initMap();
        
        window.addEventListener('beforeunload', function() {
            if (isSharing) {
                stopSharing();
            }
        });
        
        console.log('üöó Proto driver with Altitude ready');
    </script>
</body>
</html>
